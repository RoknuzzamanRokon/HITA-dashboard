<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Backend Connection</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 10px 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .success {
        background: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .loading {
        background: #fff3cd;
        color: #856404;
        padding: 12px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        padding: 12px;
        border-radius: 4px;
        margin: 10px 0;
      }
      pre {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Backend Connection Debug</h1>
      <p>
        Testing connection to
        <code
          >http://127.0.0.1:8002/v1.0/hotels/check-my-active-suppliers-info</code
        >
      </p>

      <div>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="testWithoutAuth()">Test Without Auth</button>
        <button onclick="testCORS()">Test CORS</button>
        <button onclick="clearResults()">Clear Results</button>
      </div>

      <div id="status"></div>
      <div id="results"></div>
    </div>

    <script>
      const API_BASE_URL = "http://127.0.0.1:8002/v1.0";
      const TEST_TOKEN =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1cnNhbXJva28iLCJ1c2VyX2lkIjoiMWEyMDNjY2RhNCIsInJvbGUiOiJzdXBlcl91c2VyIiwiZXhwIjoxNzY0MjM3NDE2LCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzYyNDM3NDE2fQ.Ri1GAYk-PYv9rrwnYcjNxemUyKOIRbFoI2QtBgmjsOI";

      function setStatus(message, type = "loading") {
        const statusDiv = document.getElementById("status");
        statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
      }

      function displayResults(data, title = "Results") {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = `
                <h3>${title}</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
      }

      async function testConnection() {
        setStatus("ðŸ”„ Testing authenticated connection...", "loading");

        try {
          const response = await fetch(
            `${API_BASE_URL}/hotels/check-my-active-suppliers-info`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${TEST_TOKEN}`,
                "Content-Type": "application/json",
              },
              mode: "cors",
            }
          );

          console.log("Response status:", response.status);
          console.log("Response headers:", [...response.headers.entries()]);

          if (response.ok) {
            const data = await response.json();
            setStatus("âœ… Connection successful!", "success");
            displayResults(data, "API Response Data");
          } else {
            const errorText = await response.text();
            setStatus(
              `âŒ HTTP ${response.status}: ${response.statusText}`,
              "error"
            );
            displayResults(
              {
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries()),
                body: errorText,
              },
              "Error Response"
            );
          }
        } catch (error) {
          console.error("Connection failed:", error);
          setStatus(`âŒ Connection failed: ${error.message}`, "error");

          if (error.message.includes("fetch")) {
            displayResults(
              {
                error: "Network/CORS Error",
                message: error.message,
                possibleCauses: [
                  "Backend server is not running on http://127.0.0.1:8002",
                  "CORS is not configured to allow requests from this origin",
                  "Firewall or network blocking the connection",
                ],
                solutions: [
                  "Check if backend server is running: curl http://127.0.0.1:8002/v1.0/hotels/check-my-active-suppliers-info",
                  "Verify CORS configuration allows requests from http://localhost:* or this origin",
                  "Check network connectivity and firewall settings",
                ],
              },
              "Debug Information"
            );
          } else {
            displayResults({ error: error.message }, "Error Details");
          }
        }
      }

      async function testWithoutAuth() {
        setStatus("ðŸ”„ Testing connection without authentication...", "loading");

        try {
          const response = await fetch(
            `${API_BASE_URL}/hotels/check-my-active-suppliers-info`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
              mode: "cors",
            }
          );

          console.log("Response status (no auth):", response.status);

          if (response.status === 401) {
            setStatus(
              "âœ… Server is responding (401 Unauthorized as expected)",
              "success"
            );
            displayResults(
              {
                message:
                  "Server is reachable and responding with 401 Unauthorized",
                note: "This is expected for protected endpoints without authentication",
              },
              "Connection Test Result"
            );
          } else {
            const data = await response.text();
            setStatus(
              `â„¹ï¸ Server responded with status ${response.status}`,
              "info"
            );
            displayResults(
              {
                status: response.status,
                statusText: response.statusText,
                body: data,
              },
              "Server Response"
            );
          }
        } catch (error) {
          setStatus(`âŒ Connection failed: ${error.message}`, "error");
          displayResults({ error: error.message }, "Connection Error");
        }
      }

      async function testCORS() {
        setStatus("ðŸ”„ Testing CORS preflight...", "loading");

        try {
          // Test OPTIONS request (CORS preflight)
          const response = await fetch(
            `${API_BASE_URL}/hotels/check-my-active-suppliers-info`,
            {
              method: "OPTIONS",
              headers: {
                "Access-Control-Request-Method": "GET",
                "Access-Control-Request-Headers": "Authorization, Content-Type",
              },
              mode: "cors",
            }
          );

          console.log("CORS preflight status:", response.status);
          console.log("CORS headers:", [...response.headers.entries()]);

          const corsHeaders = {
            "Access-Control-Allow-Origin": response.headers.get(
              "Access-Control-Allow-Origin"
            ),
            "Access-Control-Allow-Methods": response.headers.get(
              "Access-Control-Allow-Methods"
            ),
            "Access-Control-Allow-Headers": response.headers.get(
              "Access-Control-Allow-Headers"
            ),
            "Access-Control-Allow-Credentials": response.headers.get(
              "Access-Control-Allow-Credentials"
            ),
          };

          if (response.ok || response.status === 204) {
            setStatus("âœ… CORS preflight successful", "success");
          } else {
            setStatus(`âš ï¸ CORS preflight returned ${response.status}`, "info");
          }

          displayResults(
            {
              preflightStatus: response.status,
              corsHeaders: corsHeaders,
              allHeaders: Object.fromEntries(response.headers.entries()),
            },
            "CORS Configuration"
          );
        } catch (error) {
          setStatus(`âŒ CORS test failed: ${error.message}`, "error");
          displayResults(
            {
              error: error.message,
              note: "CORS preflight failed - this usually means the server is not configured for CORS or is not running",
            },
            "CORS Error"
          );
        }
      }

      function clearResults() {
        document.getElementById("status").innerHTML = "";
        document.getElementById("results").innerHTML = "";
      }

      // Auto-test on page load
      window.addEventListener("load", () => {
        setStatus("Ready to test backend connection", "info");
      });
    </script>
  </body>
</html>
