<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Check Login Status</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 700px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 4px solid;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border-color: #28a745;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #dc3545;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border-color: #17a2b8;
      }
      .warning {
        background-color: #fff3cd;
        color: #856404;
        border-color: #ffc107;
      }

      button {
        padding: 12px 20px;
        margin: 5px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: white;
        font-size: 16px;
      }
      button:hover {
        background-color: #0056b3;
      }

      .log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        max-height: 400px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }

      .instructions {
        background-color: #e7f3ff;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” Check Login Status After Backend 200 OK</h1>

      <div class="instructions">
        <h3>ğŸ“‹ Instructions:</h3>
        <ol>
          <li>
            <strong>Try to login</strong> in the app:
            <a href="http://localhost:3000/login" target="_blank"
              >http://localhost:3000/login</a
            >
          </li>
          <li><strong>Use credentials:</strong> roman / roman123</li>
          <li>
            <strong>After login attempt</strong> (successful or not), come back
            here
          </li>
          <li><strong>Click "Check Status"</strong> to see what happened</li>
        </ol>
      </div>

      <div>
        <button onclick="checkLoginStatus()">ğŸ” Check Login Status</button>
        <button onclick="openApp()">ğŸ“± Open App Login</button>
        <button onclick="openDashboard()">ğŸ  Try Dashboard</button>
        <button onclick="clearAll()">ğŸ§¹ Clear All Data</button>
      </div>

      <div id="status" class="status info">Ready to check login status</div>

      <div class="log" id="log"></div>
    </div>

    <script>
      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
        updateStatus(message, type);
      }

      function updateStatus(message, type = "info") {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
      }

      function checkLoginStatus() {
        clearLog();
        log("ğŸ” Checking current login status...");

        // Check all possible storage locations
        const adminToken = localStorage.getItem("admin_auth_token");
        const adminRefresh = localStorage.getItem("admin_refresh_token");
        const authSession = localStorage.getItem("auth-session");

        log("ğŸ“‹ Storage Check:");
        log(`  ğŸ« admin_auth_token: ${adminToken ? "EXISTS" : "NOT FOUND"}`);
        log(
          `  ğŸ”„ admin_refresh_token: ${adminRefresh ? "EXISTS" : "NOT FOUND"}`
        );
        log(`  ğŸ“‹ auth-session: ${authSession ? "EXISTS" : "NOT FOUND"}`);

        if (adminToken) {
          log("âœ… Login token found!", "success");
          log(`ğŸ” Token preview: ${adminToken.substring(0, 50)}...`);

          // Try to decode JWT
          try {
            const parts = adminToken.split(".");
            if (parts.length === 3) {
              const payload = JSON.parse(atob(parts[1]));
              log("ğŸ” JWT Token Details:");
              log(`  ğŸ‘¤ Subject: ${payload.sub || "N/A"}`);
              log(`  ğŸ‘¤ User ID: ${payload.user_id || "N/A"}`);
              log(`  ğŸ‘¤ Role: ${payload.role || "N/A"}`);

              if (payload.exp) {
                const expDate = new Date(payload.exp * 1000);
                const isExpired = payload.exp < Math.floor(Date.now() / 1000);
                log(`  â° Expires: ${expDate.toLocaleString()}`);
                log(
                  `  âœ… Valid: ${isExpired ? "NO (EXPIRED)" : "YES"}`,
                  isExpired ? "error" : "success"
                );
              }
            } else {
              log("âš ï¸ Token format unusual (not standard JWT)", "warning");
            }
          } catch (e) {
            log("âš ï¸ Could not decode token as JWT", "warning");
          }
        } else {
          log("âŒ No login token found", "error");
          log("ğŸ’¡ This means login didn't complete successfully", "info");
        }

        if (authSession) {
          try {
            const session = JSON.parse(authSession);
            log("ğŸ“‹ Session Details:");
            log(`  ğŸ” Authenticated: ${session.isAuthenticated}`);
            log(`  ğŸ‘¤ Username: ${session.username || "N/A"}`);
            log(`  ğŸ‘¤ User ID: ${session.userId || "N/A"}`);
            log(
              `  â° Last Activity: ${new Date(
                session.lastActivity
              ).toLocaleString()}`
            );
          } catch (e) {
            log("âŒ Could not parse session data", "error");
          }
        }

        // Final assessment
        if (adminToken && authSession) {
          log(
            "ğŸ‰ LOGIN SUCCESSFUL! You should be able to access dashboard",
            "success"
          );
          log("ğŸš€ Try clicking 'Try Dashboard' button above", "info");
        } else if (adminToken) {
          log("âš ï¸ Token exists but no session - partial login", "warning");
        } else {
          log(
            "âŒ Login not completed - check browser console for errors",
            "error"
          );
          log("ğŸ’¡ Common issues:", "info");
          log("  - JavaScript errors preventing token storage", "info");
          log("  - Network errors during API call", "info");
          log("  - Backend returning invalid response format", "info");
        }
      }

      function openApp() {
        log("ğŸ“± Opening app login page...");
        window.open("http://localhost:3000/login", "_blank");
      }

      function openDashboard() {
        log("ğŸ  Opening dashboard...");
        window.open("http://localhost:3000/dashboard", "_blank");
      }

      function clearAll() {
        clearLog();
        log("ğŸ§¹ Clearing all authentication data...");

        const keys = [
          "admin_auth_token",
          "admin_refresh_token",
          "auth-session",
          "mock_current_token",
          "mock_current_user",
        ];

        keys.forEach((key) => {
          localStorage.removeItem(key);
          sessionStorage.removeItem(key);
        });

        log("âœ… All data cleared", "success");
      }

      // Auto-check on load
      setTimeout(() => {
        log("ğŸ”§ Auto-checking login status...");
        checkLoginStatus();
      }, 1000);
    </script>
  </body>
</html>
