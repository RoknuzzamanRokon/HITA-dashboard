<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memory Monitor Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
      }
      .memory-info {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
      }
      .memory-high {
        background: #fff3cd;
        border-color: #ffeaa7;
      }
      .memory-low {
        background: #f8d7da;
        border-color: #f5c6cb;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin: 10px 0;
      }
      .stat {
        text-align: center;
        padding: 10px;
        background: #e9ecef;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Memory Monitor Test</h1>
      <p>This page tests the memory monitoring functionality.</p>

      <div id="memory-status" class="memory-info">
        <h3>Memory Status</h3>
        <div id="memory-details">Checking memory...</div>
      </div>

      <div class="stats">
        <div class="stat">
          <strong>Recommended Limit</strong>
          <div id="recommended-limit">-</div>
        </div>
        <div class="stat">
          <strong>Can Load 10K Items?</strong>
          <div id="can-load-test">-</div>
        </div>
      </div>

      <div>
        <button onclick="checkMemory()">Check Memory</button>
        <button onclick="testLargeArray()">Test Large Array</button>
        <button onclick="clearMemory()">Clear Memory</button>
      </div>

      <div id="test-results"></div>
    </div>

    <script>
      // Simple memory monitoring implementation for testing
      class SimpleMemoryMonitor {
        getMemoryInfo() {
          if (!("memory" in performance)) {
            return null;
          }

          const memInfo = performance.memory;
          const usedMB = Math.round(memInfo.usedJSHeapSize / 1048576);
          const totalMB = Math.round(memInfo.totalJSHeapSize / 1048576);
          const limitMB = Math.round(memInfo.jsHeapSizeLimit / 1048576);
          const usagePercentage = Math.round((usedMB / limitMB) * 100);

          return {
            usedMB,
            totalMB,
            limitMB,
            usagePercentage,
            isLowMemory: usagePercentage > 80,
            isHighMemory: usagePercentage > 60,
          };
        }

        canPerformOperation(itemCount, bytesPerItem = 1024) {
          const memInfo = this.getMemoryInfo();
          if (!memInfo) return true;

          const estimatedMemoryMB = Math.round(
            (itemCount * bytesPerItem) / 1048576
          );
          const projectedUsage =
            ((memInfo.usedMB + estimatedMemoryMB) / memInfo.limitMB) * 100;

          return projectedUsage < 90;
        }

        getRecommendedDisplayLimit() {
          const memInfo = this.getMemoryInfo();
          if (!memInfo) return 1000;

          if (memInfo.isLowMemory) return 250;
          if (memInfo.isHighMemory) return 500;
          return 1000;
        }

        getMemoryWarning(itemCount) {
          const memInfo = this.getMemoryInfo();
          if (!memInfo) return null;

          if (memInfo.isLowMemory) {
            return `High memory usage (${memInfo.usagePercentage}%). Showing limited results to prevent browser crashes.`;
          }

          if (memInfo.isHighMemory && itemCount > 1000) {
            return `Memory usage is elevated (${memInfo.usagePercentage}%). Consider using pagination or filters.`;
          }

          return null;
        }
      }

      const monitor = new SimpleMemoryMonitor();
      let testArray = [];

      function checkMemory() {
        const memInfo = monitor.getMemoryInfo();
        const statusDiv = document.getElementById("memory-status");
        const detailsDiv = document.getElementById("memory-details");

        if (!memInfo) {
          detailsDiv.innerHTML =
            "<p>Memory monitoring not supported in this browser.</p>";
          return;
        }

        // Update status styling
        statusDiv.className = "memory-info";
        if (memInfo.isLowMemory) {
          statusDiv.className += " memory-low";
        } else if (memInfo.isHighMemory) {
          statusDiv.className += " memory-high";
        }

        detailsDiv.innerHTML = `
                <div class="stats">
                    <div class="stat">
                        <strong>Used Memory</strong>
                        <div>${memInfo.usedMB} MB</div>
                    </div>
                    <div class="stat">
                        <strong>Total Memory</strong>
                        <div>${memInfo.totalMB} MB</div>
                    </div>
                    <div class="stat">
                        <strong>Memory Limit</strong>
                        <div>${memInfo.limitMB} MB</div>
                    </div>
                    <div class="stat">
                        <strong>Usage</strong>
                        <div>${memInfo.usagePercentage}%</div>
                    </div>
                </div>
                <p><strong>Status:</strong> ${
                  memInfo.isLowMemory
                    ? "üî¥ Low Memory"
                    : memInfo.isHighMemory
                    ? "üü° High Usage"
                    : "üü¢ Normal"
                }</p>
            `;

        // Update recommended limit
        document.getElementById("recommended-limit").textContent = monitor
          .getRecommendedDisplayLimit()
          .toLocaleString();

        // Update can load test
        const canLoad = monitor.canPerformOperation(10000);
        document.getElementById("can-load-test").textContent = canLoad
          ? "‚úÖ Yes"
          : "‚ùå No";

        // Show warning if any
        const warning = monitor.getMemoryWarning(1000);
        if (warning) {
          detailsDiv.innerHTML += `<p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 10px;"><strong>Warning:</strong> ${warning}</p>`;
        }
      }

      function testLargeArray() {
        const resultsDiv = document.getElementById("test-results");
        resultsDiv.innerHTML = "<p>Creating large array...</p>";

        try {
          // Create a large array to test memory usage
          const size = 100000;
          testArray = new Array(size).fill(0).map((_, i) => ({
            id: i,
            name: `Item ${i}`,
            data: new Array(100).fill(`data-${i}`).join(","),
          }));

          resultsDiv.innerHTML = `<p style="color: green;">‚úÖ Successfully created array with ${size.toLocaleString()} items</p>`;

          // Check memory after creating array
          setTimeout(checkMemory, 100);
        } catch (error) {
          resultsDiv.innerHTML = `<p style="color: red;">‚ùå Failed to create large array: ${error.message}</p>`;
        }
      }

      function clearMemory() {
        testArray = [];

        // Force garbage collection if available
        if ("gc" in window) {
          window.gc();
        }

        document.getElementById("test-results").innerHTML =
          '<p style="color: blue;">üßπ Memory cleared</p>';

        // Check memory after clearing
        setTimeout(checkMemory, 100);
      }

      // Initial memory check
      checkMemory();

      // Auto-refresh every 5 seconds
      setInterval(checkMemory, 5000);
    </script>
  </body>
</html>
