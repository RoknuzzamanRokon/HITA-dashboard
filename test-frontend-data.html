<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Frontend Data Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 10px 5px;
      }
      button:hover {
        background: #0056b3;
      }
      pre {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      .iframe-container {
        margin: 20px 0;
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
      }
      iframe {
        width: 100%;
        height: 600px;
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Frontend Data Display Test</h1>
      <p>
        This test checks if the hotel dashboard is properly displaying data from
        the backend API.
      </p>

      <div>
        <button onclick="testDashboardInIframe()">
          Load Dashboard in Frame
        </button>
        <button onclick="openDashboardInNewTab()">
          Open Dashboard in New Tab
        </button>
        <button onclick="testAPIDirectly()">Test API Directly</button>
        <button onclick="clearResults()">Clear Results</button>
      </div>

      <div id="results"></div>

      <div class="iframe-container" id="iframe-container" style="display: none">
        <iframe id="dashboard-iframe" src=""></iframe>
      </div>

      <div class="test-result info">
        <h3>Manual Testing Instructions:</h3>
        <ol>
          <li>
            <strong>Open Dashboard:</strong> Click "Open Dashboard in New Tab"
            or navigate to
            <a href="http://localhost:3000/dashboard/hotels" target="_blank"
              >http://localhost:3000/dashboard/hotels</a
            >
          </li>
          <li>
            <strong>Check Authentication:</strong> The page should load without
            showing "Authentication Required"
          </li>
          <li>
            <strong>Verify Data Loading:</strong> Look for these elements:
            <ul>
              <li>Statistics cards should show numbers (not "N/A" or "...")</li>
              <li>Total Hotels: ~5.7M</li>
              <li>Active Hotels: ~4.9M</li>
              <li>Pending Hotels: ~577K</li>
              <li>Recent Updates: ~288K</li>
            </ul>
          </li>
          <li>
            <strong>Check Top Suppliers:</strong> Should show real supplier
            names like "itt", "ratehawkhotel", "tbohotel"
          </li>
          <li>
            <strong>Check Regional Distribution:</strong> Should show
            percentages for North America, Europe, Asia Pacific, Other
          </li>
          <li>
            <strong>Browser Console:</strong> Open Developer Tools (F12) and
            check for:
            <ul>
              <li>
                ‚úÖ Successful API calls to
                /hotels/check-my-active-suppliers-info
              </li>
              <li>‚úÖ "Hotel info loaded:" log messages</li>
              <li>‚ùå No authentication errors</li>
              <li>‚ùå No CORS errors</li>
            </ul>
          </li>
        </ol>
      </div>

      <div class="test-result warning">
        <h3>Common Issues & Solutions:</h3>
        <ul>
          <li>
            <strong>Shows "Authentication Required":</strong> The auth context
            isn't working. Check browser console for auth errors.
          </li>
          <li>
            <strong>Shows "N/A" or "..." in cards:</strong> API calls are
            failing. Check network tab in developer tools.
          </li>
          <li>
            <strong>CORS errors:</strong> Backend CORS configuration issue.
            Backend needs to allow requests from localhost:3000.
          </li>
          <li>
            <strong>Loading forever:</strong> Check if backend is running on
            http://127.0.0.1:8002
          </li>
        </ul>
      </div>
    </div>

    <script>
      const BACKEND_URL = "http://127.0.0.1:8002/v1.0";
      const FRONTEND_URL = "http://localhost:3000";
      const TEST_TOKEN =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1cnNhbXJva28iLCJ1c2VyX2lkIjoiMWEyMDNjY2RhNCIsInJvbGUiOiJzdXBlcl91c2VyIiwiZXhwIjoxNzY0MjM3NDE2LCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzYyNDM3NDE2fQ.Ri1GAYk-PYv9rrwnYcjNxemUyKOIRbFoI2QtBgmjsOI";

      function addResult(message, type = "info") {
        const resultsDiv = document.getElementById("results");
        const resultDiv = document.createElement("div");
        resultDiv.className = `test-result ${type}`;
        resultDiv.innerHTML = message;
        resultsDiv.appendChild(resultDiv);
      }

      function clearResults() {
        document.getElementById("results").innerHTML = "";
        document.getElementById("iframe-container").style.display = "none";
      }

      function testDashboardInIframe() {
        addResult("üì± Loading dashboard in iframe...", "info");

        const iframe = document.getElementById("dashboard-iframe");
        const container = document.getElementById("iframe-container");

        iframe.src = `${FRONTEND_URL}/dashboard/hotels`;
        container.style.display = "block";

        iframe.onload = function () {
          addResult(
            "‚úÖ Dashboard loaded in iframe. Check the frame below for data display.",
            "success"
          );

          // Try to access iframe content (may be blocked by same-origin policy)
          try {
            const iframeDoc =
              iframe.contentDocument || iframe.contentWindow.document;
            const statsCards = iframeDoc.querySelectorAll(
              '[class*="stat-value"], [class*="text-2xl"]'
            );

            if (statsCards.length > 0) {
              addResult(
                `üìä Found ${statsCards.length} potential statistics elements in the dashboard.`,
                "info"
              );
            } else {
              addResult(
                "‚ö†Ô∏è Could not detect statistics elements. Manual verification needed.",
                "warning"
              );
            }
          } catch (error) {
            addResult(
              "‚ÑπÔ∏è Cannot access iframe content due to security restrictions. Please verify manually.",
              "info"
            );
          }
        };

        iframe.onerror = function () {
          addResult(
            "‚ùå Failed to load dashboard in iframe. Try opening in a new tab.",
            "error"
          );
        };
      }

      function openDashboardInNewTab() {
        addResult("üöÄ Opening dashboard in new tab...", "info");
        window.open(`${FRONTEND_URL}/dashboard/hotels`, "_blank");
        addResult(
          "‚úÖ Dashboard opened. Check the new tab for data display.",
          "success"
        );
      }

      async function testAPIDirectly() {
        addResult("üîÑ Testing backend API directly...", "info");

        try {
          const response = await fetch(
            `${BACKEND_URL}/hotels/check-my-active-suppliers-info`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${TEST_TOKEN}`,
                "Content-Type": "application/json",
              },
              mode: "cors",
            }
          );

          if (response.ok) {
            const data = await response.json();

            addResult("‚úÖ Backend API is working correctly!", "success");
            addResult(
              `üìä API Data Summary:
‚Ä¢ Total Hotels: ${
                data.supplierAnalytics?.totalHotelsAccessible?.toLocaleString() ||
                "N/A"
              }
‚Ä¢ Active Suppliers: ${data.supplierAnalytics?.activeSuppliers || "N/A"}
‚Ä¢ Coverage: ${data.supplierAnalytics?.accessCoveragePercentage || "N/A"}%
‚Ä¢ Top Supplier: ${data.accessibleSuppliers?.[0]?.supplierName || "N/A"} (${
                data.accessibleSuppliers?.[0]?.totalHotels?.toLocaleString() ||
                "N/A"
              } hotels)`,
              "info"
            );

            // Show what the frontend should display
            const expectedFrontendData = {
              totalHotels: data.supplierAnalytics?.totalHotelsAccessible || 0,
              activeHotels: Math.floor(
                (data.supplierAnalytics?.totalHotelsAccessible || 0) * 0.85
              ),
              pendingHotels: Math.floor(
                (data.supplierAnalytics?.totalHotelsAccessible || 0) * 0.1
              ),
              recentUpdates: Math.floor(
                (data.supplierAnalytics?.totalHotelsAccessible || 0) * 0.05
              ),
            };

            addResult(
              `üéØ Expected Frontend Display:
‚Ä¢ Total Hotels: ${expectedFrontendData.totalHotels.toLocaleString()}
‚Ä¢ Active Hotels: ${expectedFrontendData.activeHotels.toLocaleString()}
‚Ä¢ Pending Hotels: ${expectedFrontendData.pendingHotels.toLocaleString()}
‚Ä¢ Recent Updates: ${expectedFrontendData.recentUpdates.toLocaleString()}`,
              "success"
            );
          } else {
            addResult(
              `‚ùå Backend API failed: HTTP ${response.status} ${response.statusText}`,
              "error"
            );
          }
        } catch (error) {
          addResult(`‚ùå Backend API error: ${error.message}`, "error");
          addResult(
            "üí° Make sure the backend server is running on http://127.0.0.1:8002",
            "warning"
          );
        }
      }

      // Auto-run API test on page load
      window.addEventListener("load", () => {
        setTimeout(testAPIDirectly, 1000);
      });
    </script>
  </body>
</html>
